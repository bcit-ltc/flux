# Kustomization for `latest` environment
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  # - ../../../apps
  # - ../../../infrastructure
  # - cloudnative-pg.yaml
  - vault-secrets-operator.yaml
  - tailscale.yaml

labels:
- includeSelectors: true
  pairs:
    environment: latest

patches:

  - target:
      kind: Kustomization
    patch: |-
      - op: add
        path: /spec/components
        value: [../../../components/env-latest]

  # Update oci repository ref selection to target latest chart images
  - target:
      kind: OCIRepository
      annotationSelector: "config.fluxcd.io/workload-type=app"
    patch: |-
      - op: replace
        path: /spec/ref
        value: {"tag": "latest"}

  # Patches Fluxcd "GitLab Webhook" ingress to facilitate reconciliation
  - target:
      kind: Ingress
      annotationSelector: "app=flux"
    patch: |-
      - op: replace
        path: /spec/rules/0/host
        value: flux.latest.ltc.bcit.ca
      - op: replace
        path: /spec/tls/0/hosts/0
        value: flux.latest.ltc.bcit.ca

  # Add the environment label to all resources in the Helm chart
  - target:
      kind: HelmRelease
    patch: |-
      - op: add
        path: /spec/postRenderers
        value:
          - kustomize:
              patches:
                - target:
                    kind: .*
                  patch: |
                    apiVersion: v1
                    kind: ConfigMap   # placeholder; not used
                    metadata:
                      name: placeholder
                      labels:
                        environment: latest



  # Remove all stable resources (this env should only emit latest resources)
  #   - delete patch taken from https://github.com/kubernetes-sigs/kustomize/issues/1593
  - target:
      name: ingress-stable
    patch: |
      $patch: delete
      kind: Ingress
      metadata:
        name: DOES NOT MATTER

  - target:
      name: star-ltc-bcit-ca
    patch: |
      $patch: delete
      kind: VaultStaticSecret
      metadata:
        name: DOES NOT MATTER

  # Remove all stable resources
  #   - delete patch taken from https://github.com/kubernetes-sigs/kustomize/issues/1593
  #
  - target:
      kind: Ingress
    patch: |
      - op: replace
        path: /spec/tls/0/secretName
        value: star-latest-ltc-bcit-ca

