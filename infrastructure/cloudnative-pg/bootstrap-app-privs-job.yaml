---
apiVersion: batch/v1
kind: Job
metadata:
  name: bootstrap-app-privs
  namespace: postgres
spec:
  ttlSecondsAfterFinished: 600
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: psql
          image: ghcr.io/cloudnative-pg/postgresql:16
          command: ["/bin/bash", "-ceu", "--"]
          args:
            - |
              set -o pipefail

              echo "[bootstrap] Starting app privilege bootstrap"

              # Pull CNPG superuser credentials
              PGUSER="$(cat /secrets/superuser/username)"
              PGPASSWORD="$(cat /secrets/superuser/password)"
              PGDATABASE="$(cat /secrets/superuser/dbname)"
              export PGUSER PGPASSWORD PGDATABASE

              # Default connection target: pg-core primary
              PGHOST="${PGHOST:-pg-core-rw.postgres.svc.cluster.local}"
              PGPORT="${PGPORT:-5432}"
              export PGHOST PGPORT

              OWNER_ROLE="${DB_ROOT_OWNER:-db_root_owner}"

              echo "[bootstrap] Using OWNER_ROLE=${OWNER_ROLE}, PGHOST=${PGHOST}, PGPORT=${PGPORT}"

              # Iterate over each app line: "<DB_NAME> <APP_ROLE>"
              while read -r DB_NAME APP_ROLE; do
                if [[ -z "${DB_NAME:-}" ]] || [[ "${DB_NAME}" =~ ^# ]]; then
                  continue
                fi

                echo "[bootstrap] Checking existence of DB '${DB_NAME}'"

                # --- Wait for PG to be ready ---
                MAX_RETRIES=20
                RETRY_DELAY=3
                connected=false

                for ((i=1; i<=MAX_RETRIES; i++)); do
                  if psql -v ON_ERROR_STOP=0 -d postgres -c "SELECT 1;" >/dev/null 2>&1; then
                    connected=true
                    break
                  fi
                  echo "[bootstrap] PG not ready yet (attempt $i/$MAX_RETRIES)..."
                  sleep $RETRY_DELAY
                done

                if [[ "${connected}" != true ]]; then
                  echo "[bootstrap] ERROR: PG never became ready; skipping DB '${DB_NAME}'"
                  continue
                fi

                # --- Check DB existence ---
                if ! psql -Atqc "SELECT 1 FROM pg_database WHERE datname='${DB_NAME}'" >/dev/null 2>&1; then
                  echo "[bootstrap] WARNING: database '${DB_NAME}' does not exist yet; skipping"
                  continue
                fi

                echo "[bootstrap] Database '${DB_NAME}' exists; applying privilege bootstrap"

                psql \
                  "dbname=${DB_NAME}" \
                  -v ON_ERROR_STOP=1 \
                  -v DB_NAME="${DB_NAME}" \
                  -v OWNER_ROLE="${OWNER_ROLE}" \
                  -v APP_ROLE="${APP_ROLE}" \
                  -f /sql/default-privs.sql

              done < /config/apps

              echo "[bootstrap] Completed app privilege bootstrap"

          env:
            - name: DB_ROOT_OWNER
              value: db_root_owner
          volumeMounts:
            - name: app-list
              mountPath: /config
            - name: sql
              mountPath: /sql
            - name: superuser
              mountPath: /secrets/superuser

      volumes:
        - name: app-list
          configMap:
            name: app-list
            items:
              - key: apps
                path: apps
        - name: sql
          configMap:
            name: default-privs-sql
            items:
              - key: default-privs.sql
                path: default-privs.sql
        - name: superuser
          secret:
            secretName: pg-core-superuser
