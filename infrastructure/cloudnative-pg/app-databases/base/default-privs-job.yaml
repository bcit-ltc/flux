apiVersion: batch/v1
kind: Job
metadata:
  name: default-privs
  namespace: postgres
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: psql
          image: ghcr.io/cloudnative-pg/postgresql:16
          command: ["/bin/sh","-eu"]
          args:
            - |
              CONTROL_DB="postgres"
              MAX_WAIT="${MAX_WAIT:-300}"   # seconds
              SLEEP_SECS="${SLEEP_SECS:-2}"

              # 1) Wait for Postgres to accept TCP connections
              until pg_isready -h "${PGHOST}" -p "${PGPORT:-5432}" -U "${PGUSER}" -d "${CONTROL_DB}" -t 2 >/dev/null 2>&1; do
                echo "waiting for postgres at ${PGHOST}..."
                sleep "${SLEEP_SECS}"
              done

              # 2) Ensure CONNECT on control DB
              start_ts=$(date +%s)
              while :; do
                if psql -v ON_ERROR_STOP=1 -d "${CONTROL_DB}" -c "SELECT 1" >/dev/null 2>&1; then
                  break
                fi
                now=$(date +%s)
                if [ $((now - start_ts)) -ge "${MAX_WAIT}" ]; then
                  echo "Timed out getting CONNECT on ${CONTROL_DB} as ${PGUSER}."
                  exit 1
                fi
                echo "waiting for CONNECT on ${CONTROL_DB} as ${PGUSER}..."
                sleep "${SLEEP_SECS}"
              done

              # 3) Wait for the target database to exist (check output explicitly)
              start_ts=$(date +%s)
              while :; do
                out="$(psql -XtA -d "${CONTROL_DB}" -c "SELECT 1 FROM pg_database WHERE datname='${DB_NAME}'" 2>/dev/null || true)"
                if [ "${out}" = "1" ]; then
                  break
                fi
                now=$(date +%s)
                if [ $((now - start_ts)) -ge "${MAX_WAIT}" ]; then
                  echo "Timed out waiting for DB '${DB_NAME}' to exist. Ensure CNPG/bootstrap creates it."
                  exit 1
                fi
                echo "waiting for database ${DB_NAME}..."
                sleep "${SLEEP_SECS}"
              done

              # 4) Run bootstrap SQL
              psql -v ON_ERROR_STOP=1 \
                   -v DB_NAME="${DB_NAME}" \
                   -v OWNER_ROLE="${OWNER_ROLE}" \
                   -v APP_ROLE="${APP_ROLE}" \
                   -f /sql/default-privs.sql \
                   -d "${CONTROL_DB}"
          env:
            - name: DB_NAME
              valueFrom: { configMapKeyRef: { name: db-vars, key: DB_NAME } }
            - name: OWNER_ROLE
              valueFrom: { configMapKeyRef: { name: db-vars, key: OWNER_ROLE } }
            - name: APP_ROLE
              valueFrom: { configMapKeyRef: { name: db-vars, key: APP_ROLE } }
            - name: PGHOST
              value: pg-core-env-rw.postgres.svc.cluster.local
            - name: PGUSER
              valueFrom: { secretKeyRef: { name: init-secret, key: username } }
            - name: PGPASSWORD
              valueFrom: { secretKeyRef: { name: init-secret, key: password } }
            # Optional:
            # - name: MAX_WAIT
            #   value: "600"
            # - name: SLEEP_SECS
            #   value: "2"
          volumeMounts:
            - name: sql
              mountPath: /sql
      volumes:
        - name: sql
          configMap:
            name: default-privs-sql
            items:
              - key: default-privs.sql
                path: default-privs.sql
