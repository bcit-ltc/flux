---
apiVersion: v1
kind: ConfigMap
metadata:
  name: default-privs-sql
  namespace: postgres
data:
  default-privs.sql: |
    \set ON_ERROR_STOP 1
    -- Expected variables:
    --   -v DB_NAME=...      (e.g. qcon_api)
    --   -v OWNER_ROLE=...   (e.g. db_root_owner)
    --   -v APP_ROLE=...     (e.g. qcon_api_app)

    -- Create APP_ROLE (group role) if missing
    SELECT format('CREATE ROLE %I NOLOGIN;', :'APP_ROLE')
    WHERE NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = :'APP_ROLE') \gexec

    -- Grant CONNECT to the app role on the database
    SELECT format('GRANT CONNECT ON DATABASE %I TO %I;', :'DB_NAME', :'APP_ROLE') \gexec

    -- Work in the target DB
    \connect :DB_NAME

    -- Ensure schema exists (schema name == DB_NAME)
    SELECT format('CREATE SCHEMA IF NOT EXISTS %I;', :'DB_NAME') \gexec

    -- USAGE + CREATE on schema for the app role (CREATE is required for migrations)
    SELECT format('GRANT USAGE, CREATE ON SCHEMA %I TO %I;', :'DB_NAME', :'APP_ROLE') \gexec

    -- Privileges on existing objects
    SELECT format('GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA %I TO %I;', :'DB_NAME', :'APP_ROLE') \gexec
    SELECT format('GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA %I TO %I;', :'DB_NAME', :'APP_ROLE') \gexec

    -- Default privileges for future objects created by OWNER_ROLE
    SELECT format('ALTER DEFAULT PRIVILEGES FOR ROLE %I IN SCHEMA %I GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO %I;',
                  :'OWNER_ROLE', :'DB_NAME', :'APP_ROLE') \gexec
    SELECT format('ALTER DEFAULT PRIVILEGES FOR ROLE %I IN SCHEMA %I GRANT USAGE, SELECT ON SEQUENCES TO %I;',
                  :'OWNER_ROLE', :'DB_NAME', :'APP_ROLE') \gexec

    -- Set OWNER_ROLE search_path in this DB
    \connect postgres
    SELECT format('ALTER ROLE %I IN DATABASE %I SET search_path = %I, public;',
                  :'OWNER_ROLE', :'DB_NAME', :'DB_NAME') \gexec
