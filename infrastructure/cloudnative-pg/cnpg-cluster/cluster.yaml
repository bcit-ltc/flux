apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: pg-core
  namespace: postgres
spec:
  instances: 3
  imageName: ghcr.io/cloudnative-pg/postgresql:16
  enableSuperuserAccess: true

  storage:
    size: 20Gi

  managed:
    services:
      additional:
        - selectorType: rw
          serviceTemplate:
            metadata:
              name: pg-core-nodeport
            spec:
              type: NodePort
              ports:
                - name: postgres
                  port: 5432
                  targetPort: 5432
                  nodePort: 31432

    roles:
      # Infra-level admin, used by Vault DB connection and bootstrap jobs
      - name: vault_manager
        ensure: present
        login: true
        createrole: true
        createdb: true
        superuser: false
        passwordSecret:
          name: vault-manager-secret

      # Shared owner role for all application databases
      # (DBs and schemas are owned by this role; app roles get privileges)
      - name: db_root_owner
        ensure: present
        login: true
        superuser: false
        createdb: true
        # no passwordSecret: CNPG will manage the role internally; we don't need to log in as this user from K8s

  postgresql:
    # hostssl for external traffic; TLS is required.
    pg_hba:

      # In-cluster apps (example pod CIDR for RKE2; adjust to your cluster)
      - host    all  all  10.42.0.0/16      scram-sha-256

      # Vault VM (single host) (TODO: move to encoded patch)
      - hostssl all  all  142.232.110.63/32   scram-sha-256

      # Admin/jumpbox range (TODO: move to encoded patch)
      - hostssl all  all  142.232.0.0/16   scram-sha-256
      - hostssl all  all  192.68.68.0/24   scram-sha-256
      - hostssl all  all  10.42.0.0/16   scram-sha-256
      - hostssl all  all  10.67.0.0/16   scram-sha-256
